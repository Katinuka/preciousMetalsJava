<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Info and Live Metal Prices</title>

    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/script.js"></script>
</head>
<body>

<!-- User Balance in Top Right Corner -->
<div class="user-info">
    <h3>User Information</h3>
    <p><strong>Username:</strong> <span th:text="${user.username}"></span></p>
    <ul>
        <!-- Loop through user's balance -->
        <li th:each="entry : ${user.balance}">
            <span th:text="${entry.key}"></span>:
            <span th:text="${entry.value}"></span>
        </li>
    </ul>
</div>

<!-- Metal Purchase/Sell Form -->
<div class="purchase-form">
    <h3 id="form-title">Buy Metals</h3>
    <form id="metal-transaction-form">
        <label for="transaction-type">Action:</label>
        <select id="transaction-type" name="transaction-type">
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
        </select>

        <label for="metal">Select Metal:</label>
        <select id="metal" name="metal">
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
            <option value="Platinum">Platinum</option>
            <option value="Palladium">Palladium</option>
        </select>

        <label for="ounces">Enter Ounces:</label>
        <input type="number" id="ounces" name="ounces" min="1" step="0.01">

        <p>Total Price: <span id="total-price">0.00</span> USD</p>
        <button type="button" onclick="performTransaction()">Submit</button>
    </form>
</div>



<!-- Main content area centered -->
<div class="content">

    <!-- Live Metal Prices in the center -->
    <div class="prices">
        <h2>Live Metal Prices</h2>
        <table>
            <thead>
            <tr>
                <th>Metal</th>
                <th>Price (USD)</th>
            </tr>
            </thead>
            <tbody id="price-table-body">
            <!-- Thymeleaf will populate the metal prices here -->
            <tr th:each="priceEntry : ${prices}">
                <td th:text="${priceEntry.key}"></td>
                <td th:text="${priceEntry.value}"></td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

<!--<script>-->
<!--    let metalPrices = {};-->

<!--    function reloadData() {-->
<!--        fetch('/api/metals')-->
<!--            .then(response => response.json())-->
<!--            .then(data => {-->
<!--                // Store the fetched prices in the global variable-->
<!--                metalPrices = data;-->

<!--                // Clear the price table body-->
<!--                const priceTableBody = document.getElementById('price-table-body');-->
<!--                priceTableBody.innerHTML = ''; // Clear existing rows-->

<!--                // Populate the price table with updated data-->
<!--                for (const [metal, price] of Object.entries(data)) {-->
<!--                    const row = document.createElement('tr');-->

<!--                    const metalCell = document.createElement('td');-->
<!--                    metalCell.textContent = metal;-->
<!--                    row.appendChild(metalCell);-->

<!--                    const priceCell = document.createElement('td');-->
<!--                    priceCell.textContent = price.toFixed(2); // Format price to 2 decimal places-->
<!--                    row.appendChild(priceCell);-->

<!--                    priceTableBody.appendChild(row);-->
<!--                }-->

<!--                // Update the total price for the buy form (if user has selected a metal and entered ounces)-->
<!--                updateTotalPrice();-->
<!--            })-->
<!--            .catch(error => console.error('Error fetching metal prices:', error));-->
<!--    }-->

<!--    function updateTotalPrice() {-->
<!--        const metal = document.getElementById("metal").value;-->
<!--        const ounces = document.getElementById("ounces").value;-->
<!--        const pricePerOunce = metalPrices[metal];-->

<!--        if (pricePerOunce && ounces) {-->
<!--            const totalPrice = pricePerOunce * ounces;-->
<!--            document.getElementById("total-price").innerText = totalPrice.toFixed(2);-->
<!--        }-->
<!--    }-->

<!--    function updateUserBalance(newBalance) {-->
<!--        const userBalanceElement = document.querySelector('.user-info ul');-->

<!--        // Clear the existing balance-->
<!--        userBalanceElement.innerHTML = '';-->

<!--        // Loop through the updated balance and update the UI-->
<!--        for (const [currency, balance] of Object.entries(newBalance)) {-->
<!--            const li = document.createElement('li');-->

<!--            // Create span for currency key-->
<!--            const currencySpan = document.createElement('span');-->
<!--            currencySpan.textContent = currency;-->

<!--            // Create separator text-->
<!--            const separator = document.createTextNode(': ');-->

<!--            // Create span for balance value-->
<!--            const balanceSpan = document.createElement('span');-->
<!--            balanceSpan.textContent = balance.toFixed(2);-->

<!--            // Append the spans and text to the li-->
<!--            li.appendChild(currencySpan);-->
<!--            li.appendChild(separator);-->
<!--            li.appendChild(balanceSpan);-->

<!--            // Append the updated li to the user balance list-->
<!--            userBalanceElement.appendChild(li);-->
<!--        }-->
<!--    }-->

<!--    function performTransaction() {-->
<!--        const action = document.getElementById("transaction-type").value;-->
<!--        const metal = document.getElementById("metal").value;-->
<!--        const ounces = document.getElementById("ounces").value;-->
<!--        const pricePerOunce = metalPrices[metal];-->

<!--        if (!metal || !ounces || ounces <= 0) {-->
<!--            alert("Please enter a valid amount of ounces");-->
<!--            return;-->
<!--        }-->

<!--        const endpoint = action === "buy" ? '/user/buy-metal' : '/user/sell-metal';-->

<!--        fetch(endpoint, {-->
<!--            method: 'POST',-->
<!--            headers: {-->
<!--                'Content-Type': 'application/json',-->
<!--            },-->
<!--            body: JSON.stringify({-->
<!--                metal,-->
<!--                ounces,-->
<!--                pricePerOunce,-->
<!--            }),-->
<!--        })-->
<!--            .then(response => response.json())-->
<!--            .then(data => {-->
<!--                if (data.status === 'success') {-->
<!--                    updateUserBalance(data.balance); // Update the user balance on the front end-->
<!--                    alert(`${action === 'buy' ? 'Purchase' : 'Sale'} successful!`);-->
<!--                    reloadData(); // Refresh data to reflect the new balance-->
<!--                } else {-->
<!--                    alert(`Error: ${data.message}`);-->
<!--                }-->
<!--            })-->
<!--            .catch(error => console.error('Error:', error));-->
<!--    }-->

<!--    // Event listeners to update total price when input changes-->
<!--    document.getElementById("metal").addEventListener("change", updateTotalPrice);-->
<!--    document.getElementById("ounces").addEventListener("input", updateTotalPrice);-->

<!--    setInterval(reloadData, 100);-->

<!--    // Fetch data immediately when the page loads-->
<!--    window.onload = reloadData;-->
<!--</script>-->

</body>
</html>